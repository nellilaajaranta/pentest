# H h3 The Box

Tero Karvisen [Tunkeutumistestaus 2023-kurssin](https://terokarvinen.com/2023/tunkeutumistestaus-2023-kevat/) h3-tehtäväraporttini.

## x) Katso ja tiivistä (Tässä x-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen tai kuunteleminen ja tiivistelmä riittää. Tiivistämiseen riittää muutama ranskalainen viiva.)

tiivistelmä videosta [IppSec-videosta HackTheBox - Knife](https://www.youtube.com/watch?v=93JnRTF5sQM)

Videolla korkataan HackTheBoxin Knife-kone, joka on Linux-pohjainen. 

	- Ensimmäisenä kone skannataan Nmapilla, koneella oli kaksi porttia auki (22/ssh & 80/http)
	- Seuraavaksi tarkistettiin koneen osoite selaimella, josta avautui terveydenhuollon palvelun sivusto
	- Sivuston lähdekoodi tarkistettiin, mutta siitä ei löytynyt mitään josta voisi olla hyötyä
	- Seuraavaksi testattiin (ip-osoite)/index.(pääte), jotta serverin extension selviää: tämä oli php
	- Sivulla voi siis ajaa php skriptejä, videolla tätä hyödynnettiin gobuster-työkalulla (bruteforce-työkalu)
	- Sen jälkeen tarkastettiin sivuston liikennettä Burp suitella, josta löytyi .dev-päätteinen php, tätä haettiin internetistä ja selvisi että kys. Php:ssä on takaovi
	- Kys. Takaovea kokeiltiin useassa eri mudoossa, mutta se ei toiminut (mitään ei tapahdu)
Selvisi että kyselyn headerissa oli kirjoitusvirhe, sen korjauksen jälkeen saatiin vastaus ja lopulta shell-yhteys koneelle

## a) We like to shop. Ratkaise Portswigger Academyn "Lab: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data". (Tee tarvittaessa tunnus Portswigger Academyyn).

Labrassa tuli saada verkkokaupan piilotetut tuotteet esille SQL injektion avulla käyttäen hyväksi tuotefiltterin haavoittuvuutta. Käytin tähän työkaluna ZAP:ia.

Avasin PortSwiggerin labran sivun ja laitoin ZAP:n "set break on all requests and responses" -vihreän painikkeen päälle keskeyttääkseni liikenteen. Sitten painoin satunnaista verkkokaupan tuotekategoriafiltteriä saadakseni sen verkko-osoitteen esille ZAP:iin voidakseni muokata sitä. Tein sen perään seuraavan muutoksen:

`GET https://web-security-academy.net/filter?category=Clothing%2c+shoes+and+accessories'+OR+1+=1-- HTTP/1.1`

![kysely](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/PortS_1.PNG)

+merkit siksi, että verkko-osoitteessa ei voi olla välejä. Lähetin tämän muokatun kyselyn eteenpäin ZAP:ssa, ja tämä injektio toimi eli verkkokauppa näytti uusia, piilotettuja tuotteita:

![tulos](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/Ports_2.PNG)

## b) HTB. Tee HackTheBox.com tunnus. Avaa OpenVPN-yhteys "Starting Point" verkkoon. Estä tunnelin ulkopuolinen liikenne eli liikenne oikeaan Internettiin (vinkit alla). Testaa, että normaali Internet-liikenteesi on estetty.

Loin tunnuksen HackTheBoxiin ja klikkasin sivun oikealla olevaa painiketta "Connect to HTB".

![connection](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB1.jpg)

Tämän jälkeen valitsin "OpenVPN".

![OpenVPN](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB2.jpg)

Jätin oletusasetukset seuraavasta näkymästä ja latasin OpenVPN:n tiedoston.

![conf](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB3.jpg)

Seuraavaksi seurasin [Tero Karvisen ohjetta/vihjettä](https://terokarvinen.com/2023/tunkeutumistestaus-2023-kevat/) (h3 The Box-tehtävänannon alla) OpenVPN:n käyttöönottoa varten.

Avasin terminaalin kautta network connections-näkymän seuraavalla komennolla:

`nm-connection-editor`

Verkkoasetuksissa loin uuden yhteysmuodon +-merkistä, ja valitsin avautuvan näkymän pudotusvalikosta "import a saved VPN configuration…" ja painoin create:

![network](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB4.jpg)

Sitten valitsin juuri lataamani OpenVPN-tiedoston, jätin sen oletusasetukset päälle ja painoin save. Tämän jälkeen otin tämän juuri luodun yhteyden käyttöön avaamalla Kalin oikean ylänurkan verkkoasetuksista "VPN Connections" alta tämän VPN-yhteyden.

![vpn](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB5.jpg)

Yritin päivittää HackTheBoxin sivua tämän jälkeen, mutta sivu jäi jumiin lataamaan ja antoi "network error" varoituksia enkä pystynyt tehdä mitään. Laitoin VPN-yhteyden pois päältä ja päivitin sivun, jolloin HTB ilmoitti että olisin yhdistäneenä siihen sekä pääsin nyt tekemään HackTheBoxin taskit + spawn machine , mutta verkkoyhteyteni oli yhä tallella eli yhteys jäi jonkinlaiseen välitilaan. Kokeilin vaihtaa serveriä EU StartingPoint2, joka toimi, mutta ulkopuolinen liikenne ei ollut estetty. Päätin kuitenkin jatkaa tehtävien tekoa.

![connection](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB7.jpg)

## c) Meow. Käynnistä "Starting point": "Meow". (Spawn machine). Tallenna ruutukaappaus sivusta, jossa näkyy koneen osoite ja tunkeutumistehtäviä. Porttiskannaa kone ja analysoi tulokset. Suorita HTB:n antamat tehtävät. Raportoi normaalisti, "Starting point" -koneista saa julkaista läpikävelyohjeita.

Käynnistin koneen "spawn machine" painikkeesta. Se käynnistyi:

![meow](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow1.jpg)

Task-tehtävät olivat hyvin helppoja perusteita, joten en avaa niitä enempää kuvien lisäksi.

![task1](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB8.jpg)

![task2](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow3.jpg)

![Task3](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow4.jpg)

![Task4](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow5.jpg)

![Task5](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow6.jpg)

![Task6](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow7.jpg)

![Task7](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow8.jpg)

![Task8](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow9.jpg)

Tunnel interfacen lyhenteen sain selville selvitellessäni aiempaa VPN-ongelmaani.

Seuraavaksi porttiskannasin meow-koneen nmapilla seuraavalla komennolla:

`Nmap -sV 10.129.133.84`

-sV siksi, että näen palveluiden versiot. Tulos:

![nmap](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_nmapscan.jpg)

Kuvasta näkyy, että koneessa on auki TCP-portti 23, joka on telnetin portti. Tämän johdosta kokeilin telnet-yhteyttä siihen. Perustuen Task 8-tehtävän vastaukseen root, kokeilin sitä kirjautumiseen, joka onnistui:

![meow telnet](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_telnet.jpg)

Root flagin saamiseksi en oikein tajunnut mistä aloittaa, joten menin lukemaan meow:sta tarjotun walkthrough:n, jonka saa avattua target machinen ip-osoitteen alta. Selvisi että `ls` komennolla saa näkyviin "flag.txt"-tiedoston, jossa root flag on eli tehtävä olikin hyvin yksinkertainen.

![meow ls](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_ls.jpg)

Seuraavaksi katsoin cat-komennolla tiedoston sisällön:

`cat flag.txt`

![meow cat](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_flag.jpg)

Kopioin tämän submit flag-kenttään:

![root flag](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_flag2.jpg)

Meow suoritettu:

![meow done](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/HTB_meow_done.jpg)



## d) Fawn. Ratkaise Fawn. (HTB Starting point)

Fawn 

Käynnistin koneen "spawn machine"- painikkeesta.

Task 5 tehdessä tajusin, että kone olisi hyvä skannata ennen taskien tekoa, joten skannasin sen Nmapilla:

`nmap -sV 10.129.39.110`

![nmap](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_nmap.jpg)

Koneessa on auki portti 21 eli FTP-portti (File Transfer Protocol).

![fawn online](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_online.jpg)

Taskit

![Task1](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t1.jpg)

![Task2](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t2.jpg)

![Task3](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t3.jpg)

^"Secure File Transfer Protocol"

![Task4](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t4.jpg)

![Task5](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t5.jpg)

![Task6](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t6.jpg)

^tämä selvisi koneen porttiskannauksesta

![Task7](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t7.jpg)

![Task8](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t8.jpg)

^Tähän en keksinyt vastausta edes vihjeen avulla, vaan jouduin etsimään sen verkosta. [medium.com/Kamal S](https://medium.com/@Kamal_S/hack-the-box-fawn-solution-6fc646bb753c) on julkaissut ohjeen Fawniin, josta löysin vastauksen "anonymous".

Seuraavaa taskia varten kokeilin ottaa ftp-yhteyden kohdekoneeseen seuraavalla komennolla:

`ftp 10.129.39.110`

Tämä onnistui ja kokeilin Task 8 perustuen kirjautua tunnuksella "anonymous" ilman salasanaa, tämäkin onnistui:

![FTP login](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_ftplogin.jpg)

Kuvasta näkyy, että vastauskoodi on 230.

![Task9](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t9.jpg)

![Task10](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t10.jpg)

![Task11](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_t11.jpg)

Root flagin saadakseni listasin ensin `ls` -komennolla kohteen sisällön, josta selvisi että siellä on "flag.txt" -tiedosto. Latasin tämän omalle koneelleni seuraavalla komennolla:

`get flag.txt`

Tämä onnistui ja poistuin kohdekoneen FTP:stä komennolla `exit`

![FTP get](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_ftpget_flag.jpg)

Tämän jälkeen lisäsin taas `ls` -komennolla oman koneeni tiedostot ja flag.txt löytyi. FTP lataa tiedoston siihen sijaintiin, jossa olen ennen yhteyden muodostusta. Sijainnin voi vaihtaa FTP-yhteyden aikana `lcd [hakemistopolku johon halutaan]` -komennolla (local change dir).

Selvitin flag.txt-tiedoston sisällön komennolla:

`cat flag.txt`

![cat](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_cat.jpg)

Kopion tämän HTB:n root flag-taskin kenttään:

![root flag](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_root%20flag.jpg)

Fawn on nyt tehty. 

![Fawn done](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/fawn_done.jpg)

## e) Dancing. Ratkaise Dancing. (HTB Starting point)

Käynnistin koneen "spawn machine"- painikkeesta.

![spawn machine](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_online.PNG)

Tämän jälkeen porttiskannasin sen nmapilla:

`nmap -sV 10.129.1.12`

![nmap]()

Kohde näyttäisi olevan Windows-käytöjärjestelmällä ja siinä on auki kolme porttia.

![Task1](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t1.PNG)

![Task2](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t2.jpg)

Task 2 en olisi teinnyt vastausta ilman porttiskannauksen tulosta, joten etsin lisää tietoa verkosta. [varonis.com/Michael Buckbee](https://www.varonis.com/blog/smb-port) löytyi selkeä selostus SMB:stä ja sen porteista. 139 on NetBIOS:n portti, jossa SMB aiemmin on toiminut. Nykyään SMB käyttää porttia 445.

[Task3](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t3.jpg)

^tämän vastaus selvisi porttiskannauksesta.

![Task4](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t4.jpg)

^tässä kohtaa tarkistin tehtävän vihjeen, josta unohdin ottaa kuvan - siinä mainittiin vastauksen liittyvän listaan (list) ja edeltävän viivan.

Task 5 tarkistin vihjeestä apua, sillä SMB on itselleni vieraampi. Sen perusteella kokeilin muodostaa SMB-yhteyden kohdekoneeseen:

![Task5hint](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t5_hint.jpg)

![Task5 connect](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t5_smbconnect.jpg)

Yhteyksiä näyttää olevan neljä.

![Task5](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t5.jpg)

Task 6 varten tulisi selvittää, mihin jakoon on pääsy. Tarkistin HTB:n dancing walkthrough:sta (väliaikainen linkki tähän muodostuu spawn machinen jälkeen koneen ip:n alle) oikean komennon, sillä en tiennyt tätä:

`smbclient \\\\kohde-ip)\\(jako)`

Eli jos haluan muodostaa yhteyden esimerkiksi admin-jakoon, komento näyttää tältä:

`smbclient \\\\10.129.1.12\\ADMIN$`

![admin failed](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t6_access%20failed.PNG.jpg)

Kuvasta näkyy, että adminjakoon ei ole pääsyä. Kokeilin läpi kaikki, ja lopulta pääsin "IPC$" ja "WorkShares"-jakoon - "IPC$" ei kuitenkaan dancingin walkthrough:n mukaan ole osa kohteen tiedostojärjestelmää, joten se ei ole taskin kannalta oleellinen.

![Task6](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t6.jpg)

![Task7](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_t7.jpg)

^veikkasin komentoa `get` perustuen vaadittavaan kirjainmäärään, joak osoittautui oikeaksi vastaukseksi.

Root flagin selvittämiseksi kokeilin ls-komentoa, ja kohteesta löytyi kaksi hakemistoa:

![ls](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_ls.jpg)

Kokeilin ensin `cd` -komennolla "Amy.J" -hakemistoa. Sieltä löytyi "worknotes"-tiedosto, josta en ollut täysin varma löytyykö oikeat tiedot, joten menin ensin katsomaan toiesn hakemiston sisällön ennen toimenpiteitä. "James.P" -hakemsitosta löytyi flag.txt-tiedosto.

![flagfound](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_flagfound.jpg)

Seuraavaksi latasin flag.txt-tiedoston itselleni komennolla:

`get flag.txt`

Ja poistuin SMB:stä `exit` -komennolla.

![get flag](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_getflag.jpg)

Sitten tarkistin lataamani tiedoston sisällön komennolla:

`cat flag.txt`

![cat](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_cat.jpg)

Kopioin root flag-arvon HTB:n vastauskenttään.
![root flag](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_rootflag.jpg)

Dancing tehty.

![done](https://github.com/nellilaajaranta/pentest/blob/main/pictures/h3/dancing_done.jpg)
